<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Il Mio Pollaio</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#f59e0b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">

    <!-- Tailwind CSS (Styling) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js (Grafici) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome (Icone) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Stili personalizzati per PWA */
        body {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            background-color: #f3f4f6;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .safe-bottom {
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }
        /* Animazioni semplici */
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #f59e0b; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Readonly inputs style override */
        input:disabled, select:disabled {
            background-color: #f9fafb;
            color: #4b5563;
            border-color: #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col overflow-hidden text-gray-800">

    <!-- HEADER / NAV -->
    <header id="main-header" class="bg-yellow-500 text-white shadow-md z-20 flex justify-between items-center p-4 transition-colors duration-300">
        <div class="flex items-center gap-3">
            <i class="fa-solid fa-egg text-2xl"></i>
            <div class="flex flex-col">
                <h1 class="text-xl font-bold tracking-wide leading-tight" id="page-title">Il Mio Pollaio</h1>
                <span id="viewing-label" class="text-[10px] font-mono hidden opacity-80">VISTA OSPITE</span>
            </div>
        </div>
        <div id="user-info" class="hidden flex items-center gap-3">
            <!-- Share Button (Solo proprietario) -->
            <button id="btn-share-app" onclick="openShareModal()" class="hidden text-white hover:text-yellow-100 transition-colors">
                <i class="fa-solid fa-share-nodes text-xl"></i>
            </button>
            
            <!-- Switch Profile (Se invitato) -->
            <div class="relative">
                <button id="btn-switch-profile" onclick="toggleProfileMenu()" class="hidden text-white bg-white/20 p-2 rounded-full hover:bg-white/30 transition-colors">
                    <i class="fa-solid fa-users text-sm"></i>
                </button>
                <!-- Dropdown Menu -->
                <div id="profile-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl text-gray-800 py-1 border border-gray-100 z-50">
                    <p class="px-4 py-2 text-xs font-bold text-gray-400 uppercase border-b">Visualizza Dati Di:</p>
                    <div id="profile-list">
                        <!-- Popolato via JS -->
                    </div>
                </div>
            </div>

            <img id="user-avatar" src="" class="w-8 h-8 rounded-full border-2 border-white">
            <button onclick="logout()" class="text-sm bg-yellow-600 px-2 py-1 rounded shadow"><i class="fa-solid fa-right-from-bracket"></i></button>
        </div>
    </header>

    <!-- MAIN CONTENT AREA -->
    <main id="app-container" class="flex-1 overflow-y-auto p-4 safe-bottom relative">
        
        <!-- LOGIN VIEW -->
        <section id="view-login" class="flex flex-col items-center justify-center h-full space-y-6">
            <div class="text-center">
                <div class="bg-white p-6 rounded-full shadow-lg inline-block mb-4">
                    <!-- Icona Aggiornata -->
                    <img src="https://img.icons8.com/color/192/chicken.png" class="w-24 h-24" alt="Pollaio Logo">
                </div>
                <h2 class="text-2xl font-bold text-gray-700">Gestione Pollaio</h2>
                <p class="text-gray-500 mt-2">Accedi per gestire le tue galline</p>
            </div>
            <button onclick="loginWithGoogle()" class="bg-white text-gray-700 font-semibold py-3 px-6 rounded-lg shadow-md flex items-center gap-3 active:scale-95 transition-transform border border-gray-300">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" class="w-6 h-6">
                Accedi con Google
            </button>
        </section>

        <!-- DASHBOARD (LISTA POLLAI) -->
        <section id="view-dashboard" class="hidden fade-in space-y-4 pb-20">
            <!-- Statistiche rapide globali -->
            <div class="grid grid-cols-2 gap-4 mb-4">
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-yellow-400">
                    <p class="text-xs text-gray-500 uppercase">Uova Settimana</p>
                    <p class="text-2xl font-bold text-gray-800" id="dash-weekly-eggs"><i class="fa-solid fa-spinner fa-spin text-sm"></i></p>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-400">
                    <p class="text-xs text-gray-500 uppercase">Totale Anno</p>
                    <p class="text-2xl font-bold text-gray-800" id="dash-yearly-eggs"><i class="fa-solid fa-spinner fa-spin text-sm"></i></p>
                </div>
            </div>

            <h3 class="text-lg font-bold text-gray-700 ml-1">I tuoi Pollai</h3>
            <div id="coops-list" class="space-y-4">
                <!-- I pollai verranno inseriti qui via JS -->
            </div>

            <!-- Empty State -->
            <div id="no-coops-msg" class="hidden text-center py-10 text-gray-500">
                <i class="fa-solid fa-house-chimney text-4xl mb-3 text-gray-300"></i>
                <p>Nessun pollaio creato.</p>
                <p class="text-sm">Tocca il + per iniziare.</p>
            </div>
            
            <!-- Versione App -->
            <div class="text-center mt-10 mb-4">
                <p class="text-[10px] text-gray-400">App v2.0</p>
            </div>
        </section>

        <!-- DETTAGLIO POLLAIO (LISTA GALLINE) -->
        <section id="view-coop-detail" class="hidden fade-in space-y-4 pb-20">
            <button onclick="goBack('dashboard')" class="text-yellow-600 font-semibold mb-2 flex items-center gap-2 hover:text-yellow-700 transition-colors">
                <i class="fa-solid fa-arrow-left"></i> Torna ai Pollai
            </button>
            
            <div class="bg-white rounded-xl shadow-sm p-4 flex items-center gap-4 mb-2">
                <div class="w-16 h-16 bg-gray-200 rounded-lg flex items-center justify-center text-3xl border border-gray-300">üè†</div>
                <div>
                    <h2 class="text-xl font-bold" id="detail-coop-name">Nome Pollaio</h2>
                    <p class="text-sm text-gray-500" id="detail-coop-members">Caricamento...</p>
                </div>
            </div>

            <!-- Tab Navigation -->
            <div class="flex bg-gray-200 p-1 rounded-lg mb-4">
                <button onclick="switchCoopTab('members')" id="tab-members" class="flex-1 py-2 text-sm font-medium rounded-md bg-white shadow text-gray-800 transition-all">Membri</button>
                <button onclick="switchCoopTab('stats')" id="tab-stats" class="flex-1 py-2 text-sm font-medium rounded-md text-gray-500 transition-all">Statistiche</button>
            </div>

            <!-- TAB: MEMBRI -->
            <div id="content-members" class="space-y-4">
                <div id="chickens-list" class="grid grid-cols-1 gap-3">
                    <!-- Galline JS -->
                </div>
            </div>

            <!-- TAB: STATISTICHE AVANZATE -->
            <div id="content-stats" class="hidden space-y-6">
                
                <!-- BLOCCO 1: ANALISI GRAFICA -->
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <h4 class="font-bold text-gray-700 mb-2">Analisi Produzione</h4>
                    
                    <!-- Filtro Gallina -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-400 uppercase mb-1">Soggetto</label>
                        <select id="stats-filter-chicken" onchange="updateChartFromCache()" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50">
                            <option value="all">Tutto il Pollaio</option>
                            <!-- Options popolate via JS -->
                        </select>
                    </div>

                    <!-- Selezione Periodo -->
                    <div class="flex flex-col gap-3 mb-4">
                         <label class="block text-xs font-bold text-gray-400 uppercase">Periodo Temporale</label>
                        <div class="flex justify-center space-x-2">
                            <button onclick="setChartPeriod('week')" id="btn-period-week" class="px-3 py-1 text-xs bg-yellow-100 text-yellow-700 rounded-full hover:bg-yellow-200 ring-2 ring-yellow-300 font-bold transition-all">Settimana</button>
                            <button onclick="setChartPeriod('month')" id="btn-period-month" class="px-3 py-1 text-xs bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-all">Mese</button>
                            <button onclick="setChartPeriod('year')" id="btn-period-year" class="px-3 py-1 text-xs bg-gray-100 text-gray-600 rounded-full hover:bg-gray-200 transition-all">Anno</button>
                        </div>
                        
                        <!-- Input dinamici per data -->
                        <div class="mt-1">
                            <input type="week" id="input-stats-week" onchange="updateChartFromCache()" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 hidden">
                            <input type="month" id="input-stats-month" onchange="updateChartFromCache()" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 hidden">
                            <select id="input-stats-year" onchange="updateChartFromCache()" class="w-full p-2 border border-gray-300 rounded-lg text-sm bg-gray-50 hidden">
                                <!-- Popolato via JS -->
                            </select>
                        </div>
                    </div>

                    <!-- Grafico -->
                    <div class="relative h-64 w-full mb-6">
                        <canvas id="eggsChart"></canvas>
                    </div>

                    <!-- Blocchi Statistiche Periodo -->
                    <div class="grid grid-cols-2 gap-3 mb-2">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Totale Periodo</span>
                            <span class="text-2xl font-bold text-yellow-600" id="chart-stat-total">-</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Media Giornaliera</span>
                            <span class="text-xl font-bold text-gray-700" id="chart-stat-avg-day">-</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Media Settimanale</span>
                            <span class="text-lg font-bold text-gray-800" id="chart-stat-avg-week">-</span>
                        </div>
                        <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Media Mensile</span>
                            <span class="text-lg font-bold text-gray-800" id="chart-stat-avg-month">-</span>
                        </div>
                    </div>
                </div>

                <!-- BLOCCO 2: ANDAMENTO -->
                <div class="bg-white p-4 rounded-xl shadow-sm mt-4">
                    <h4 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-arrow-trend-up text-yellow-500"></i> Andamento
                    </h4>
                    
                    <!-- Ultimi 7 Giorni -->
                    <div class="flex items-center justify-between p-3 bg-blue-50 rounded-lg border border-blue-100 mb-3">
                        <div>
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Ultimi 7 Giorni</span>
                            <span class="text-2xl font-bold text-gray-800" id="trend-7d-val">-</span>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-400 font-bold uppercase block">vs prec.</span>
                            <span class="text-lg font-bold" id="trend-7d-delta">-</span>
                        </div>
                    </div>

                    <!-- Ultimi 30 Giorni -->
                    <div class="flex items-center justify-between p-3 bg-purple-50 rounded-lg border border-purple-100 mb-3">
                        <div>
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Ultimi 30 Giorni</span>
                            <span class="text-2xl font-bold text-gray-800" id="trend-30d-val">-</span>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-400 font-bold uppercase block">vs prec.</span>
                            <span class="text-lg font-bold" id="trend-30d-delta">-</span>
                        </div>
                    </div>

                    <!-- Ultimo Uovo -->
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 flex justify-between items-center">
                        <span class="text-xs text-gray-500 font-bold uppercase">Ultimo Uovo</span>
                        <span class="font-bold text-gray-700" id="trend-days-since">- Giorni fa</span>
                    </div>
                </div>

            </div>
        </section>

        <!-- FORM: CREA POLLAIO -->
        <section id="view-add-coop" class="hidden fade-in bg-white h-full absolute inset-0 z-30 p-4">
            <h2 class="text-xl font-bold mb-6">Nuovo Pollaio</h2>
            <form id="form-coop" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome Pollaio</label>
                    <input type="text" id="input-coop-name" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-3 focus:ring-yellow-500 focus:border-yellow-500" placeholder="Es. Pollaio Parabiago">
                </div>
                <div class="flex gap-2 mt-8">
                    <button type="button" onclick="goBack('dashboard')" class="w-1/2 py-3 border border-gray-300 rounded-lg text-gray-700">Annulla</button>
                    <button type="submit" class="w-1/2 py-3 bg-yellow-500 text-white rounded-lg font-bold shadow-md">Crea</button>
                </div>
            </form>
        </section>

        <!-- FORM: GESTIONE GALLINA (UNIFICATO) -->
        <section id="view-add-chicken" class="hidden fade-in bg-white h-full absolute inset-0 z-30 p-4 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold" id="chicken-form-title">Nuova Gallina</h2>
                <button type="button" id="btn-delete-chicken" onclick="deleteCurrentChicken()" class="hidden text-red-500 p-2 hover:bg-red-50 rounded-full">
                    <i class="fa-solid fa-trash"></i>
                </button>
            </div>
            
            <form id="form-chicken" class="space-y-4 pb-20">
                <!-- ID Nascosto -->
                <input type="hidden" id="input-chk-id">

                <div>
                    <label class="block text-sm font-medium text-gray-700">Nome</label>
                    <input type="text" id="input-chk-name" required class="mt-1 w-full border rounded-lg p-3 disabled:opacity-75" placeholder="Es. Rosita">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Razza/Specie</label>
                        <input type="text" id="input-chk-breed" class="mt-1 w-full border rounded-lg p-3 disabled:opacity-75" placeholder="Es. Livornese">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Sesso</label>
                        <select id="input-chk-sex" class="mt-1 w-full border rounded-lg p-3 bg-white disabled:opacity-75">
                            <option value="F">Femmina</option>
                            <option value="M">Maschio</option>
                        </select>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Colore Piumaggio</label>
                        <input type="text" id="input-chk-color" class="mt-1 w-full border rounded-lg p-3 disabled:opacity-75" placeholder="Es. Rossa">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Data di Nascita</label>
                        <input type="date" id="input-chk-birth" required class="mt-1 w-full border rounded-lg p-3 disabled:opacity-75">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Colore Uova</label>
                    <select id="input-chk-eggcolor" class="mt-1 w-full border rounded-lg p-3 bg-white disabled:opacity-75">
                        <option value="#fcd34d">Crema</option>
                        <option value="#92400e">Marrone</option>
                        <option value="#ffffff">Bianco</option>
                        <option value="#a7f3d0">Verde/Blu</option>
                    </select>
                </div>

                <div class="flex items-center justify-between p-3 border rounded-lg">
                    <span class="text-gray-700">In deposizione attiva?</span>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="input-chk-active" checked class="sr-only peer" disabled>
                        <div id="toggle-bg" class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <!-- STATISTICHE DETTAGLIATE GALLINA (Solo lettura) -->
                <div id="chk-stats-block" class="hidden mt-6 space-y-4">
                    <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wider border-b pb-2">Report Produzione</h3>
                    
                    <!-- Settimana Corrente Visuale -->
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                        <p class="text-xs text-gray-500 font-bold uppercase mb-3">Settimana Corrente</p>
                        <div class="flex justify-between items-center" id="stat-current-week-visual"></div>
                    </div>

                    <!-- Griglia Metriche -->
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-yellow-50 p-3 rounded-lg border border-yellow-100 text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Totale Anno</span>
                            <span class="text-2xl font-bold text-yellow-600" id="stat-total-year">-</span>
                        </div>
                        <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 text-center">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Giorni fa</span>
                            <span class="text-xl font-bold text-gray-700" id="stat-days-since">-</span>
                            <span class="text-[10px] text-gray-400">Ultimo uovo</span>
                        </div>
                    </div>

                    <!-- Serie (Streaks) -->
                    <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm flex justify-between items-center">
                        <div class="text-center w-1/2 border-r border-gray-100">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Serie Attuale</span>
                            <span class="text-xl font-bold text-green-600" id="stat-streak-current">-</span>
                            <span class="text-[10px] text-gray-400">giorni</span>
                        </div>
                        <div class="text-center w-1/2">
                            <span class="text-[10px] text-gray-500 font-bold uppercase block">Record</span>
                            <span class="text-xl font-bold text-gray-600" id="stat-streak-record">-</span>
                            <span class="text-[10px] text-gray-400">giorni</span>
                        </div>
                    </div>

                    <!-- Medie -->
                    <div class="bg-white p-3 rounded-lg border border-gray-100 shadow-sm">
                         <div class="flex justify-between items-center border-b border-gray-100 pb-2 mb-2">
                            <span class="text-xs text-gray-600">Media Settimanale</span>
                            <span class="font-bold text-gray-800" id="stat-avg-week">-</span>
                        </div>
                        <div class="flex justify-between items-center">
                            <span class="text-xs text-gray-600">Media Mensile</span>
                            <span class="font-bold text-gray-800" id="stat-avg-month">-</span>
                        </div>
                    </div>

                    <!-- Date Chiave -->
                    <div class="text-xs text-gray-400 flex justify-between px-1">
                        <span>1¬∞ Uovo: <b id="stat-first-egg">-</b></span>
                        <span>Ultimo: <b id="stat-last-egg">-</b></span>
                    </div>

                </div>

                <div class="flex gap-2 mt-8">
                    <button type="button" onclick="goBack('coopDetail')" class="w-1/2 py-3 border border-gray-300 rounded-lg text-gray-700">Indietro</button>
                    <button type="submit" id="btn-save-chicken" class="w-1/2 py-3 bg-yellow-500 text-white rounded-lg font-bold shadow-md">Salva</button>
                </div>
            </form>
        </section>

        <!-- MODAL: REGISTRA UOVA -->
        <div id="modal-add-eggs" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-end sm:items-center justify-center">
            <div class="bg-white w-full sm:w-96 rounded-t-2xl sm:rounded-2xl p-6 shadow-2xl transform transition-transform duration-300">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold">Registra Uova</h3>
                    <button onclick="toggleEggModal(false)" class="text-gray-400 text-xl">&times;</button>
                </div>
                
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Data Raccolta</label>
                    <input type="date" id="input-egg-date" class="w-full border-b-2 border-yellow-400 bg-gray-50 py-2 px-1 focus:outline-none font-semibold">
                </div>

                <p class="text-sm text-gray-600 mb-3">Chi ha fatto l'uovo oggi?</p>
                <div id="egg-checklist" class="space-y-2 max-h-60 overflow-y-auto mb-6">
                    <!-- Checkbox galline generate via JS -->
                </div>

                <button id="btn-confirm-egg-save" onclick="saveDailyEggs()" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 rounded-lg shadow-md">
                    Salva Raccolto
                </button>
            </div>
        </div>

        <!-- MODAL: MODIFICA POLLAIO -->
        <div id="modal-edit-coop" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4">Modifica Pollaio</h3>
                <input type="hidden" id="edit-coop-id">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nome</label>
                    <input type="text" id="edit-coop-name" class="mt-1 w-full border rounded-lg p-2">
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-edit-coop').classList.add('hidden')" class="w-1/2 py-2 border border-gray-300 rounded text-gray-700">Annulla</button>
                    <button onclick="saveCoopEdit()" class="w-1/2 py-2 bg-yellow-500 text-white rounded font-bold">Salva</button>
                </div>
            </div>
        </div>

        <!-- MODAL: CONDIVIDI (SHARE) -->
        <div id="modal-share" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white w-full max-w-sm rounded-xl p-6 shadow-2xl">
                <h3 class="text-lg font-bold mb-4 text-gray-700 flex items-center gap-2"><i class="fa-solid fa-share-nodes"></i> Condividi Accesso</h3>
                <p class="text-xs text-gray-500 mb-4">Inserisci l'email Gmail dell'utente con cui vuoi condividere il tuo pollaio in <b>sola lettura</b>.</p>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Email Ospite</label>
                    <input type="email" id="share-email-input" placeholder="es. amico@gmail.com" class="mt-1 w-full border rounded-lg p-3">
                </div>
                <div class="flex gap-2">
                    <button onclick="document.getElementById('modal-share').classList.add('hidden')" class="w-1/2 py-2 border border-gray-300 rounded text-gray-700">Annulla</button>
                    <button onclick="confirmShare()" class="w-1/2 py-2 bg-yellow-500 text-white rounded font-bold shadow-sm">Invita</button>
                </div>
            </div>
        </div>

    </main>

    <!-- FLOATING ACTION BUTTON (FAB) -->
    <button id="fab-main" onclick="handleFabClick()" class="hidden fixed bottom-6 right-6 bg-yellow-500 text-white w-14 h-14 rounded-full shadow-lg flex items-center justify-center text-2xl z-40 active:scale-90 transition-transform">
        <i class="fa-solid fa-plus"></i>
    </button>

    <!-- FIREBASE SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, doc, deleteDoc, updateDoc, getDocs, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // --- CONFIGURAZIONE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyDMEHRTExYPq1m2aV7xyPwFmSSt_u68Fls",
          authDomain: "ovetto-7cbc4.firebaseapp.com",
          projectId: "ovetto-7cbc4",
          storageBucket: "ovetto-7cbc4.firebasestorage.app",
          messagingSenderId: "6415082706",
          appId: "1:6415082706:web:fc60be4a88cd5910d4f90b"
        };
        // ----------------------------------------------------

        // Init Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // State Globali
        let currentUser = null;
        let dataOwnerId = null; // ID del proprietario dei dati (io o chi mi ha invitato)
        let isReadOnly = false; // Se true, disabilita modifiche
        
        let currentCoopId = null;
        let chickensCache = []; 
        let productionCache = [];
        let chartInstance = null;
        let currentChartPeriod = 'week';
        let sharedProfiles = []; // Lista profili condivisi

        // Elementi DOM
        const views = {
            login: document.getElementById('view-login'),
            dashboard: document.getElementById('view-dashboard'),
            coopDetail: document.getElementById('view-coop-detail'),
            addCoop: document.getElementById('view-add-coop'),
            addChicken: document.getElementById('view-add-chicken')
        };
        const fab = document.getElementById('fab-main');

        // --- AUTHENTICATION ---
        window.loginWithGoogle = () => {
            signInWithPopup(auth, provider).catch((error) => alert("Errore login: " + error.message));
        };

        window.logout = () => {
            signOut(auth);
            window.location.reload();
        };

        onAuthStateChanged(auth, async (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-avatar').src = user.photoURL;
                
                // Default: vedo i miei dati
                dataOwnerId = user.uid;
                isReadOnly = false;
                updateHeaderStyle();

                // Check inviti ricevuti
                await checkIncomingShares();

                showView('dashboard');
                loadCoops();
            } else {
                document.getElementById('user-info').classList.add('hidden');
                showView('login');
            }
        });

        // --- SHARING LOGIC ---
        
        // 1. Apri modale condivisione
        window.openShareModal = () => {
            document.getElementById('modal-share').classList.remove('hidden');
        };

        // 2. Salva invito su Firestore
        window.confirmShare = async () => {
            const email = document.getElementById('share-email-input').value.trim();
            if(!email) return alert("Inserisci una email valida");
            
            try {
                // Salviamo nella collection 'shared_access'
                // Struttura: { ownerUid: "MioID", ownerEmail: "MioEmail", viewerEmail: "AltroEmail" }
                await addDoc(collection(db, 'shared_access'), {
                    ownerUid: currentUser.uid,
                    ownerEmail: currentUser.email,
                    viewerEmail: email,
                    createdAt: Timestamp.now()
                });
                
                alert(`Accesso condiviso con ${email}`);
                document.getElementById('modal-share').classList.add('hidden');
                document.getElementById('share-email-input').value = '';
            } catch(e) { console.error(e); alert("Errore condivisione"); }
        };

        // 3. Controlla se qualcuno ha condiviso con me
        async function checkIncomingShares() {
            const q = query(collection(db, 'shared_access'), where('viewerEmail', '==', currentUser.email));
            const snapshot = await getDocs(q);
            
            sharedProfiles = [];
            // Aggiungi sempre me stesso
            sharedProfiles.push({ uid: currentUser.uid, name: "Il Mio Pollaio" });

            snapshot.forEach(doc => {
                const d = doc.data();
                sharedProfiles.push({ uid: d.ownerUid, name: `Pollaio di ${d.ownerEmail}` });
            });

            // Se ho inviti, mostra pulsante switch
            const btnSwitch = document.getElementById('btn-switch-profile');
            if(sharedProfiles.length > 1) {
                btnSwitch.classList.remove('hidden');
                renderProfileMenu();
            } else {
                btnSwitch.classList.add('hidden');
            }
            
            // Mostra pulsante Share SOLO se sono sul mio profilo
            document.getElementById('btn-share-app').classList.toggle('hidden', isReadOnly);
        }

        function renderProfileMenu() {
            const list = document.getElementById('profile-list');
            list.innerHTML = '';
            sharedProfiles.forEach(p => {
                const item = document.createElement('div');
                item.className = 'px-4 py-3 hover:bg-gray-50 cursor-pointer border-b border-gray-50 last:border-0';
                item.innerHTML = `<span class="text-sm font-medium ${p.uid === dataOwnerId ? 'text-yellow-600 font-bold' : ''}">${p.name}</span>`;
                item.onclick = () => switchProfile(p.uid);
                list.appendChild(item);
            });
        }

        window.toggleProfileMenu = () => {
            const menu = document.getElementById('profile-menu');
            menu.classList.toggle('hidden');
        };

        window.switchProfile = (targetUid) => {
            dataOwnerId = targetUid;
            isReadOnly = (targetUid !== currentUser.uid); // Se non sono io, √® solo lettura
            
            // UI Updates
            updateHeaderStyle();
            document.getElementById('profile-menu').classList.add('hidden');
            document.getElementById('btn-share-app').classList.toggle('hidden', isReadOnly);
            
            // Ricarica tutto
            showView('dashboard');
            loadCoops(); 
            // checkIncomingShares() non serve richiamare, i profili restano
            renderProfileMenu(); // Aggiorna grassetto selezione
        };

        function updateHeaderStyle() {
            const header = document.getElementById('main-header');
            const label = document.getElementById('viewing-label');
            const title = document.getElementById('page-title');
            
            if(isReadOnly) {
                // Stile Ospite (Blu)
                header.classList.remove('bg-yellow-500');
                header.classList.add('bg-blue-600');
                label.classList.remove('hidden');
                // Trova nome proprietario
                const owner = sharedProfiles.find(p => p.uid === dataOwnerId);
                title.innerText = owner ? owner.name : "Pollaio Condiviso";
            } else {
                // Stile Proprietario (Giallo)
                header.classList.add('bg-yellow-500');
                header.classList.remove('bg-blue-600');
                label.classList.add('hidden');
                title.innerText = "Il Mio Pollaio";
            }
        }


        // --- NAVIGAZIONE ---
        window.showView = (viewName) => {
            Object.values(views).forEach(el => el.classList.add('hidden'));
            if(views[viewName]) {
                views[viewName].classList.remove('hidden');
            }
            
            // Gestione FAB (Nascosto se ReadOnly)
            if(viewName === 'dashboard' && !isReadOnly) {
                fab.classList.remove('hidden');
                fab.onclick = () => showView('addCoop');
            } else if (viewName === 'coopDetail' && !isReadOnly) {
                fab.classList.remove('hidden');
                fab.onclick = () => openChickenForm('create');
            } else {
                fab.classList.add('hidden');
            }
        };

        window.goBack = (targetView) => {
            if(targetView === 'dashboard') currentCoopId = null;
            showView(targetView);
        };

        // --- GESTIONE POLLAI ---
        const formCoop = document.getElementById('form-coop');
        formCoop.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(isReadOnly) return;
            const name = document.getElementById('input-coop-name').value;
            try {
                await addDoc(collection(db, `users/${dataOwnerId}/coops`), {
                    name: name,
                    createdAt: Timestamp.now()
                });
                formCoop.reset();
                showView('dashboard');
            } catch (err) { alert("Errore creazione pollaio"); }
        });

        function loadCoops() {
            // Usa dataOwnerId invece di currentUser.uid
            const q = query(collection(db, `users/${dataOwnerId}/coops`), orderBy('createdAt', 'desc'));
            const listEl = document.getElementById('coops-list');
            
            const dashWeekly = document.getElementById('dash-weekly-eggs');
            const dashYearly = document.getElementById('dash-yearly-eggs');

            onSnapshot(q, async (snapshot) => {
                listEl.innerHTML = '';
                if (snapshot.empty) {
                    document.getElementById('no-coops-msg').classList.remove('hidden');
                    dashWeekly.innerText = "0";
                    dashYearly.innerText = "0";
                    return;
                }
                document.getElementById('no-coops-msg').classList.add('hidden');

                let globalWeek = 0;
                let globalYear = 0;
                const now = new Date();
                const oneWeekAgo = new Date();
                oneWeekAgo.setDate(now.getDate() - 7);
                const startOfYear = new Date(now.getFullYear(), 0, 1);

                for (const docSnap of snapshot.docs) {
                    const coop = docSnap.data();
                    const coopId = docSnap.id;

                    const [chickensSnap, prodSnap] = await Promise.all([
                        getDocs(collection(db, `users/${dataOwnerId}/coops/${coopId}/chickens`)),
                        getDocs(collection(db, `users/${dataOwnerId}/coops/${coopId}/production`))
                    ]);

                    const memberCount = chickensSnap.size;
                    const logs = prodSnap.docs.map(d => d.data());

                    const eggsWeek = logs.filter(l => new Date(l.date) >= oneWeekAgo).length;
                    const eggsYear = logs.filter(l => new Date(l.date) >= startOfYear).length;

                    globalWeek += eggsWeek;
                    globalYear += eggsYear;

                    // Bottoni condizionali (edit/uova) nascosti se ReadOnly
                    const actionButtons = isReadOnly ? '' : `
                        <div class="flex flex-col gap-2">
                             <button onclick="event.stopPropagation(); openEditCoop('${docSnap.id}', '${coop.name.replace(/'/g, "\\'")}')" class="bg-gray-100 text-gray-600 p-2 rounded-full w-10 h-10 flex items-center justify-center shadow-sm hover:bg-gray-200">
                                <i class="fa-solid fa-pen"></i>
                            </button>
                            <button onclick="event.stopPropagation(); openEggModal('${docSnap.id}')" class="bg-yellow-100 text-yellow-600 p-4 rounded-full w-20 h-20 flex items-center justify-center shadow-sm hover:bg-yellow-200">
                                <i class="fa-solid fa-egg text-2xl"></i>
                            </button>
                        </div>
                    `;

                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 flex justify-between items-center active:bg-gray-50 transition-colors cursor-pointer';
                    el.innerHTML = `
                        <div class="flex items-center gap-4">
                            <div class="w-16 h-16 rounded-lg bg-gray-200 border border-gray-300 flex items-center justify-center text-3xl">üè†</div>
                            <div>
                                <h3 class="font-bold text-lg">${coop.name}</h3>
                                <p class="text-sm text-gray-500">${memberCount} Galline</p>
                                <div class="flex gap-2 text-xs mt-1 text-gray-400">
                                    <span>7gg: <b>${eggsWeek}</b></span> ‚Ä¢ 
                                    <span>Anno: <b>${eggsYear}</b></span>
                                </div>
                            </div>
                        </div>
                        ${actionButtons}
                    `;
                    el.onclick = () => openCoopDetail(docSnap.id, coop);
                    listEl.appendChild(el);
                }
                
                dashWeekly.innerText = globalWeek;
                dashYearly.innerText = globalYear;
            });
        }

        window.openEditCoop = (id, currentName) => {
            if(isReadOnly) return;
            document.getElementById('edit-coop-id').value = id;
            document.getElementById('edit-coop-name').value = currentName;
            document.getElementById('modal-edit-coop').classList.remove('hidden');
        };

        window.saveCoopEdit = async () => {
            if(isReadOnly) return;
            const id = document.getElementById('edit-coop-id').value;
            const newName = document.getElementById('edit-coop-name').value;
            try {
                await updateDoc(doc(db, `users/${dataOwnerId}/coops/${id}`), {
                    name: newName
                });
                document.getElementById('modal-edit-coop').classList.add('hidden');
            } catch(e) { alert("Errore modifica"); }
        };

        window.openCoopDetail = (coopId, coopData) => {
            currentCoopId = coopId;
            document.getElementById('detail-coop-name').innerText = coopData.name;
            document.getElementById('page-title').innerText = coopData.name; // Titolo Header
            showView('coopDetail');
            loadChickensAndStats(coopId);
            switchCoopTab('members');
        };

        async function loadChickensAndStats(coopId) {
            // Usa dataOwnerId
            const chkSnap = await getDocs(collection(db, `users/${dataOwnerId}/coops/${coopId}/chickens`));
            chickensCache = chkSnap.docs.map(d => ({id: d.id, ...d.data()}));

            const prodSnap = await getDocs(collection(db, `users/${dataOwnerId}/coops/${coopId}/production`));
            productionCache = prodSnap.docs.map(d => d.data());

            document.getElementById('detail-coop-members').innerText = `${chickensCache.length} Membri`;

            const selectFilter = document.getElementById('stats-filter-chicken');
            selectFilter.innerHTML = '<option value="all">Tutto il Pollaio</option>';
            chickensCache.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.innerText = c.name;
                selectFilter.appendChild(opt);
            });

            // Popola anni
            const yearSelect = document.getElementById('input-stats-year');
            yearSelect.innerHTML = '';
            const years = [...new Set(productionCache.map(p => p.date.split('-')[0]))].sort().reverse();
            const currentYear = new Date().getFullYear().toString();
            if(!years.includes(currentYear)) years.unshift(currentYear);
            years.forEach(y => { const opt = document.createElement('option'); opt.value = y; opt.innerText = y; yearSelect.appendChild(opt); });

            const chickensListEl = document.getElementById('chickens-list');
            chickensListEl.innerHTML = '';
            const startOfYear = new Date(new Date().getFullYear(), 0, 1);

            chickensCache.forEach(c => {
                const birth = new Date(c.birthDate);
                const now = new Date();
                const diffTime = Math.abs(now - birth);
                const years = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 365));
                const months = Math.floor((diffTime % (1000 * 60 * 60 * 24 * 365)) / (1000 * 60 * 60 * 24 * 30));
                const ageString = years > 0 ? `${years} Anni, ${months} Mesi` : `${months} Mesi`;

                const personalEggs = productionCache.filter(p => p.chickenId === c.id && new Date(p.date) >= startOfYear).length;
                const cString = encodeURIComponent(JSON.stringify(c));
                const icon = c.sex === 'M' ? 'üêì' : 'üêî';

                // Edit Button: Nascosto se ReadOnly
                const editBtn = isReadOnly ? '' : `
                    <button onclick="event.stopPropagation(); openChickenForm('edit', JSON.parse(decodeURIComponent('${cString}')))" class="absolute top-2 right-2 bg-white text-yellow-600 p-2 rounded-full shadow-sm border border-gray-100 hover:bg-yellow-50 z-10">
                        <i class="fa-solid fa-pen text-sm"></i>
                    </button>`;

                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl shadow-sm border border-gray-100 relative overflow-hidden group active:bg-gray-50 cursor-pointer';
                el.innerHTML = `
                    <div onclick="openChickenForm('view', JSON.parse(decodeURIComponent('${cString}')))" class="flex items-center gap-3">
                        <div class="absolute left-0 top-0 bottom-0 w-2" style="background-color: ${c.eggColor}"></div>
                        <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center text-2xl border-2 border-white shadow-sm">
                            ${icon}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <h4 class="font-bold text-lg">${c.name}</h4>
                                <span class="text-xs font-mono bg-gray-100 px-2 py-1 rounded text-gray-600">Anno: <b>${personalEggs}</b> ü•ö</span>
                            </div>
                            <p class="text-sm text-gray-500">${c.breed} ‚Ä¢ ${ageString}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-xs flex items-center gap-1 ${c.isActive ? 'text-green-600' : 'text-red-500'}">
                                    <i class="fa-solid fa-circle text-[8px]"></i> ${c.isActive ? 'Attiva' : 'Riposo'}
                                </span>
                            </div>
                        </div>
                    </div>
                    ${editBtn}
                `;
                chickensListEl.appendChild(el);
            });

            // Set default inputs
            const today = new Date();
            document.getElementById('input-stats-month').value = today.toISOString().slice(0, 7); 

            if(!document.getElementById('content-stats').classList.contains('hidden')) {
                updateChartFromCache();
            }
        }

        // --- GESTIONE FORM UNIFICATO ---
        window.openChickenForm = (mode, data = null) => {
            showView('addChicken');
            const form = document.getElementById('form-chicken');
            const title = document.getElementById('chicken-form-title');
            const btnSave = document.getElementById('btn-save-chicken');
            const btnDelete = document.getElementById('btn-delete-chicken');
            const statsBlock = document.getElementById('chk-stats-block'); 
            const inputs = form.querySelectorAll('input, select');
            const chkActive = document.getElementById('input-chk-active');

            form.reset();
            document.getElementById('input-chk-id').value = '';
            
            // Forza readonly se siamo ospiti O se modalit√† view
            const isInputDisabled = (mode === 'view') || isReadOnly;
            inputs.forEach(i => i.disabled = isInputDisabled);

            if (mode === 'create') {
                title.innerText = "Nuova Gallina";
                btnSave.classList.remove('hidden');
                btnDelete.classList.add('hidden');
                statsBlock.classList.add('hidden'); 
                chkActive.checked = true; 
            } else {
                document.getElementById('input-chk-id').value = data.id;
                document.getElementById('input-chk-name').value = data.name;
                document.getElementById('input-chk-breed').value = data.breed || '';
                document.getElementById('input-chk-color').value = data.color || '';
                document.getElementById('input-chk-sex').value = data.sex || 'F';
                document.getElementById('input-chk-birth').value = data.birthDate;
                document.getElementById('input-chk-eggcolor').value = data.eggColor;
                chkActive.checked = data.isActive;

                if (mode === 'edit') {
                    title.innerText = "Modifica Gallina";
                    btnSave.classList.remove('hidden');
                    btnDelete.classList.remove('hidden');
                    statsBlock.classList.add('hidden'); 
                } else {
                    title.innerText = "Dettagli Gallina";
                    btnSave.classList.add('hidden'); 
                    btnDelete.classList.add('hidden');
                    statsBlock.classList.remove('hidden'); 
                    // ... (Codice calcolo statistiche avanzate esistente) ...
                    calculateChickenStats(data.id); // Refactoring per pulizia
                }
            }
        };

        function calculateChickenStats(chickenId) {
             if(productionCache && chickenId) {
                const now = new Date();
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                const myLogs = productionCache
                    .filter(p => p.chickenId === chickenId)
                    .sort((a,b) => new Date(a.date) - new Date(b.date));
                
                const countYear = myLogs.filter(l => new Date(l.date) >= startOfYear).length;
                document.getElementById('stat-total-year').innerText = countYear;

                let firstEgg = "-", lastEgg = "-", daysSince = "-";
                if(myLogs.length > 0) {
                    firstEgg = new Date(myLogs[0].date).toLocaleDateString('it-IT');
                    const lastDateObj = new Date(myLogs[myLogs.length - 1].date);
                    lastEgg = lastDateObj.toLocaleDateString('it-IT');
                    const diffTime = Math.abs(now - lastDateObj);
                    daysSince = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                }
                document.getElementById('stat-first-egg').innerText = firstEgg;
                document.getElementById('stat-last-egg').innerText = lastEgg;
                document.getElementById('stat-days-since').innerText = daysSince !== "-" ? daysSince : "N/A";

                // Streaks & Averages logic (riportata tal quale per brevit√†, gi√† funzionante)
                let currentStreak = 0, maxStreak = 0, tempStreak = 0;
                if(myLogs.length > 0) {
                    const uniqueDates = [...new Set(myLogs.map(l => l.date))];
                    for(let i=0; i<uniqueDates.length; i++) {
                        if(i === 0) tempStreak = 1;
                        else {
                            const diffDays = (new Date(uniqueDates[i]) - new Date(uniqueDates[i-1])) / (86400000);
                            if(diffDays === 1) tempStreak++;
                            else { if(tempStreak > maxStreak) maxStreak = tempStreak; tempStreak = 1; }
                        }
                    }
                    if(tempStreak > maxStreak) maxStreak = tempStreak;
                    const diffFromToday = Math.floor((now - new Date(uniqueDates[uniqueDates.length - 1])) / 86400000);
                    if(diffFromToday <= 1) {
                        currentStreak = 1;
                        for(let i = uniqueDates.length - 2; i >= 0; i--) {
                            if((new Date(uniqueDates[i+1]) - new Date(uniqueDates[i])) / 86400000 === 1) currentStreak++; else break;
                        }
                    }
                }
                document.getElementById('stat-streak-current').innerText = currentStreak;
                document.getElementById('stat-streak-record').innerText = maxStreak;

                let avgWeek = "0.0", avgMonth = "0.0";
                if(myLogs.length > 1) {
                        const daysActive = Math.max(1, Math.floor((now - new Date(myLogs[0].date)) / 86400000));
                        avgWeek = (myLogs.length / (daysActive / 7)).toFixed(1);
                        avgMonth = (myLogs.length / (daysActive / 30.44)).toFixed(1);
                }
                document.getElementById('stat-avg-week').innerText = avgWeek;
                document.getElementById('stat-avg-month').innerText = avgMonth;

                // Visual Week
                const visualContainer = document.getElementById('stat-current-week-visual');
                visualContainer.innerHTML = '';
                const startOfWeek = new Date(now);
                const day = startOfWeek.getDay() || 7; 
                if(day !== 1) startOfWeek.setHours(-24 * (day - 1));
                const daysLabels = ['L', 'M', 'M', 'G', 'V', 'S', 'D'];
                for(let i=0; i<7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    const dateStr = d.toISOString().split('T')[0];
                    const hasEgg = myLogs.some(l => l.date === dateStr);
                    const isToday = dateStr === now.toISOString().split('T')[0];
                    const circle = document.createElement('div');
                    circle.className = `flex flex-col items-center gap-1`;
                    circle.innerHTML = `<div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold transition-all ${hasEgg ? 'bg-orange-400 text-white shadow-md scale-110' : 'bg-gray-100 text-gray-400'} ${isToday ? 'ring-2 ring-yellow-400' : ''}">${hasEgg ? 'ü•ö' : ''}</div><span class="text-[10px] text-gray-400 font-bold">${daysLabels[i]}</span>`;
                    visualContainer.appendChild(circle);
                }
            }
        }

        window.deleteCurrentChicken = async () => {
            if(isReadOnly) return;
            if(!confirm("Sei sicuro di voler rimuovere questa gallina?")) return;
            const id = document.getElementById('input-chk-id').value;
            try {
                await deleteDoc(doc(db, `users/${dataOwnerId}/coops/${currentCoopId}/chickens/${id}`));
                showView('coopDetail');
                loadChickensAndStats(currentCoopId);
            } catch(e) { alert("Errore eliminazione"); }
        }

        const formChicken = document.getElementById('form-chicken');
        formChicken.addEventListener('submit', async (e) => {
            e.preventDefault();
            if(isReadOnly) return;
            // ... (logica salvataggio esistente con dataOwnerId) ...
            const chkId = document.getElementById('input-chk-id').value;
            const chickenData = {
                name: document.getElementById('input-chk-name').value,
                breed: document.getElementById('input-chk-breed').value,
                color: document.getElementById('input-chk-color').value,
                sex: document.getElementById('input-chk-sex').value,
                birthDate: document.getElementById('input-chk-birth').value,
                eggColor: document.getElementById('input-chk-eggcolor').value,
                isActive: document.getElementById('input-chk-active').checked,
                updatedAt: Timestamp.now()
            };
            try {
                if(chkId) await updateDoc(doc(db, `users/${dataOwnerId}/coops/${currentCoopId}/chickens/${chkId}`), chickenData);
                else { chickenData.createdAt = Timestamp.now(); await addDoc(collection(db, `users/${dataOwnerId}/coops/${currentCoopId}/chickens`), chickenData); }
                formChicken.reset(); showView('coopDetail'); loadChickensAndStats(currentCoopId);
            } catch (err) { console.error(err); alert("Errore salvataggio"); }
        });

        window.openEggModal = (coopId) => {
            // Se ReadOnly non faccio nulla (il pulsante non c'√®, ma per sicurezza)
            if(isReadOnly) return;
            currentCoopId = coopId;
            if(chickensCache.length === 0) {
                 getDocs(collection(db, `users/${dataOwnerId}/coops/${coopId}/chickens`)).then(snap => {
                    chickensCache = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderEggModalList();
                });
            } else {
                renderEggModalList();
            }
            document.getElementById('input-egg-date').valueAsDate = new Date();
            toggleEggModal(true);
        };

        function renderEggModalList() {
            const container = document.getElementById('egg-checklist');
            container.innerHTML = '';
            if(chickensCache.length === 0) { container.innerHTML = '<p class="text-center text-gray-400 italic">Nessuna gallina trovata.</p>'; return; }
            chickensCache.forEach(c => {
                if(!c.isActive) return;
                const div = document.createElement('div');
                div.className = 'flex items-center p-3 bg-gray-50 rounded-lg border border-gray-200';
                div.innerHTML = `<input type="checkbox" id="egg-check-${c.id}" value="${c.id}" class="w-5 h-5 text-yellow-500 rounded focus:ring-yellow-500 border-gray-300"><label for="egg-check-${c.id}" class="ml-3 block text-sm font-medium text-gray-700 w-full cursor-pointer flex justify-between">${c.name}<span class="w-3 h-3 rounded-full border border-gray-300 shadow-sm" style="background-color: ${c.eggColor}"></span></label>`;
                container.appendChild(div);
            });
        }

        window.toggleEggModal = (show) => {
            const m = document.getElementById('modal-add-eggs');
            if(show) m.classList.remove('hidden'); else m.classList.add('hidden');
        };

        window.saveDailyEggs = async () => {
            if(isReadOnly) return;
            const dateVal = document.getElementById('input-egg-date').value;
            const checks = document.querySelectorAll('input[id^="egg-check-"]:checked');
            const chickenIds = Array.from(checks).map(c => c.value);
            if(chickenIds.length === 0) { alert("Seleziona almeno una gallina!"); return; }
            try {
                for (const chkId of chickenIds) {
                    await addDoc(collection(db, `users/${dataOwnerId}/coops/${currentCoopId}/production`), {
                        date: dateVal, chickenId: chkId, timestamp: Timestamp.now()
                    });
                }
                toggleEggModal(false); alert(`Salvate ${chickenIds.length} uova!`);
                if(currentCoopId) loadChickensAndStats(currentCoopId);
                loadCoops(); 
            } catch(e) { console.error(e); alert("Errore salvataggio"); }
        };

        // --- STATISTICHE E GRAFICI (RIMANGONO UGUALI, GIA' USANO productionCache) ---
        // (Ho omesso per brevit√† le funzioni di rendering grafico che non cambiano logica, 
        //  ma nel file finale sono incluse e funzionanti perch√© productionCache √® aggiornata da loadChickensAndStats)
        
        window.switchCoopTab = (tabName) => {
            const tabs = ['members', 'stats'];
            tabs.forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.replace('text-gray-800', 'text-gray-500');
                document.getElementById(`tab-${t}`).classList.replace('bg-white', 'transparent');
                document.getElementById(`tab-${t}`).classList.remove('shadow');
            });
            document.getElementById(`content-${tabName}`).classList.remove('hidden');
            const activeTab = document.getElementById(`tab-${tabName}`);
            activeTab.classList.replace('text-gray-500', 'text-gray-800');
            activeTab.classList.remove('transparent');
            activeTab.classList.add('bg-white', 'shadow');
            if(tabName === 'stats') updateChartFromCache();
        };

        window.setChartPeriod = (period) => {
            currentChartPeriod = period;
            ['week', 'month', 'year'].forEach(p => {
                const btn = document.getElementById(`btn-period-${p}`);
                const input = document.getElementById(`input-stats-${p}`);
                if(p === period) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600'); btn.classList.add('bg-yellow-100', 'text-yellow-700', 'ring-2', 'ring-yellow-300', 'font-bold'); input.classList.remove('hidden');
                } else {
                    btn.classList.add('bg-gray-100', 'text-gray-600'); btn.classList.remove('bg-yellow-100', 'text-yellow-700', 'ring-2', 'ring-yellow-300', 'font-bold'); input.classList.add('hidden');
                }
            });
            updateChartFromCache();
        };

        // Helper: Get ISO Week
        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
            var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
            return weekNo;
        }

        window.updateChartFromCache = () => {
            if(!productionCache) return;
            const selectedChicken = document.getElementById('stats-filter-chicken').value;
            let logs = productionCache;
            if(selectedChicken !== 'all') logs = logs.filter(l => l.chickenId === selectedChicken);

            let labels = [], data = [], filteredLogs = [];
            
            if (currentChartPeriod === 'week') {
                const weekInput = document.getElementById('input-stats-week');
                if(weekInput.value) {
                    const [selYear, selWeek] = weekInput.value.split('-W').map(Number);
                    filteredLogs = logs.filter(l => { const d = new Date(l.date); return d.getFullYear() === selYear && getWeekNumber(d) === selWeek; });
                    labels = ['Lun', 'Mar', 'Mer', 'Gio', 'Ven', 'Sab', 'Dom']; data = new Array(7).fill(0);
                    filteredLogs.forEach(l => { const d = new Date(l.date); const dayIdx = d.getDay() === 0 ? 6 : d.getDay() - 1; data[dayIdx]++; });
                } else {
                    const now = new Date();
                    for(let i=6; i>=0; i--) {
                        const d = new Date(); d.setDate(now.getDate() - i); const dateStr = d.toISOString().split('T')[0];
                        labels.push(d.toLocaleDateString('it-IT', {weekday: 'short'}));
                        const count = logs.filter(l => l.date === dateStr).length;
                        data.push(count); if(count > 0) filteredLogs.push(...logs.filter(l => l.date === dateStr));
                    }
                }
            } else if (currentChartPeriod === 'month') {
                const monthInput = document.getElementById('input-stats-month').value; 
                if(monthInput) {
                    filteredLogs = logs.filter(l => l.date.startsWith(monthInput));
                    const [y, m] = monthInput.split('-'); const daysInMonth = new Date(y, m, 0).getDate();
                    labels = Array.from({length: daysInMonth}, (_, i) => i + 1); data = new Array(daysInMonth).fill(0);
                    filteredLogs.forEach(l => { const day = parseInt(l.date.split('-')[2]); data[day-1]++; });
                }
            } else if (currentChartPeriod === 'year') {
                const yearInput = document.getElementById('input-stats-year').value;
                if(yearInput) {
                    filteredLogs = logs.filter(l => l.date.startsWith(yearInput));
                    const months = ['Gen', 'Feb', 'Mar', 'Apr', 'Mag', 'Giu', 'Lug', 'Ago', 'Set', 'Ott', 'Nov', 'Dic']; labels = months; data = new Array(12).fill(0);
                    filteredLogs.forEach(l => { const m = parseInt(l.date.split('-')[1]) - 1; data[m]++; });
                }
            }
            renderChart(labels, data);
            calculateAndRenderStatsBlocks(filteredLogs);
            calculateTrends(logs);
        };

        function calculateAndRenderStatsBlocks(filteredLogs) {
            const total = filteredLogs.length;
            document.getElementById('chart-stat-total').innerText = total;
            let daysInPeriod = 1;
            if(currentChartPeriod === 'week') daysInPeriod = 7;
            else if(currentChartPeriod === 'month') { const m = document.getElementById('input-stats-month').value; if(m) { const [y, month] = m.split('-'); daysInPeriod = new Date(y, month, 0).getDate(); } else daysInPeriod = 30; }
            else if(currentChartPeriod === 'year') { const y = document.getElementById('input-stats-year').value; daysInPeriod = ((y % 4 === 0 && y % 100 > 0) || y % 400 == 0) ? 366 : 365; }
            
            document.getElementById('chart-stat-avg-day').innerText = (total / daysInPeriod).toFixed(1);
            document.getElementById('chart-stat-avg-week').innerText = (total / (daysInPeriod / 7)).toFixed(1);
            document.getElementById('chart-stat-avg-month').innerText = (total / Math.max(1, daysInPeriod / 30.44)).toFixed(1);
        }

        function calculateTrends(logs) {
            const now = new Date();
            const last7Start = new Date(); last7Start.setDate(now.getDate() - 7);
            const prev7Start = new Date(); prev7Start.setDate(now.getDate() - 14);
            const last30Start = new Date(); last30Start.setDate(now.getDate() - 30);
            const prev30Start = new Date(); prev30Start.setDate(now.getDate() - 60);
            const isBetween = (dStr, start, end) => { const d = new Date(dStr); return d >= start && d <= end; };

            const last7 = logs.filter(l => isBetween(l.date, last7Start, now)).length;
            const prev7 = logs.filter(l => isBetween(l.date, prev7Start, last7Start)).length;
            const last30 = logs.filter(l => isBetween(l.date, last30Start, now)).length;
            const prev30 = logs.filter(l => isBetween(l.date, prev30Start, last30Start)).length;

            const delta7 = last7 - prev7; const delta30 = last30 - prev30;
            let daysSince = "-";
            if(logs.length > 0) {
                const dates = logs.map(l => new Date(l.date));
                const maxDate = new Date(Math.max.apply(null, dates));
                const diff = Math.floor((now - maxDate) / (86400000));
                daysSince = diff + " Giorni fa"; if(diff === 0) daysSince = "Oggi"; if(diff === 1) daysSince = "Ieri";
            }

            document.getElementById('trend-7d-val').innerText = last7;
            const elDelta7 = document.getElementById('trend-7d-delta'); elDelta7.innerText = (delta7 > 0 ? "+" : "") + delta7; elDelta7.className = `text-lg font-bold ${delta7 >= 0 ? 'text-green-600' : 'text-red-500'}`;
            document.getElementById('trend-30d-val').innerText = last30;
            const elDelta30 = document.getElementById('trend-30d-delta'); elDelta30.innerText = (delta30 > 0 ? "+" : "") + delta30; elDelta30.className = `text-lg font-bold ${delta30 >= 0 ? 'text-green-600' : 'text-red-500'}`;
            document.getElementById('trend-days-since').innerText = daysSince;
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('eggsChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            chartInstance = new Chart(ctx, {
                type: 'bar', data: { labels: labels, datasets: [{ label: 'Uova', data: data, backgroundColor: '#f59e0b', borderRadius: 4, barThickness: currentChartPeriod === 'month' ? 6 : 12 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1 } }, x: { grid: { display: false }, ticks: { font: { size: 10 } } } }, animation: { duration: 300 } }
            });
        }
    </script>
</body>
</html>
